<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mapa (OpenLayers) · Standalone</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css">
  <style>
    :root{--bg:#0b0d10;--panel:#101419;--muted:#8b93a3;--line:#1b212b;--text:#e8ecf1;}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .layout{display:grid;grid-template-columns:320px 1fr;min-height:100vh}
    .panel{background:var(--panel);border-right:1px solid var(--line);padding:16px;overflow:auto}
    .map-wrap{position:relative}
    #map{height:100vh;width:100%;background:#9ed8e2}
    .tooltip{position:absolute;pointer-events:none;background:rgba(15,22,32,.9);color:#e8ecf1;padding:6px 10px;border-radius:8px;font-size:12px;border:1px solid var(--line);transform:translate(-50%,-120%);display:none}
    .country-list{list-style:none;margin:10px 0 0 0;padding:0;border:1px solid var(--line);border-radius:12px;max-height:260px;overflow:auto}
    .country-list li{padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer;display:flex;justify-content:space-between;gap:8px}
    .country-list li:last-child{border-bottom:none}
    .country-list li.is-active{background:#13202f}
    .search-row{display:flex;gap:8px;align-items:center}
    #search{flex:1}
    #search-badge{border:1px solid var(--line);background:#0f1620;color:#e8ecf1;border-radius:10px;padding:6px 10px;font-size:12px;min-width:64px;text-align:center}
    .selected-country{margin-top:12px;border:1px solid var(--line);border-radius:12px;padding:12px;min-height:90px}
  </style>
</head>
<body>
  <main class="layout">
    <aside class="panel">
      <h2>Mapa (OpenLayers) · Standalone</h2>
      <div class="search-row">
        <input id="search" type="text" placeholder="Buscar país por nombre…">
        <div id="search-badge">—</div>
      </div>
      <ul id="country-list" class="country-list"></ul>
      <div class="selected-country" id="selected-country">
        <div class="row"><span class="name">—</span></div>
      </div>
    </aside>
    <section class="map-wrap">
      <div id="map"></div>
      <div id="tooltip" class="tooltip"></div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const listEl = $("#country-list");
    const badgeEl = $("#search-badge");
    const tooltip = $("#tooltip");
    const nameEl = $("#selected-country .name");

    // Base OSM (otra pila de tiles que suele evitar seams)
    const base = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: "https://{a-c}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        attributions: '&copy; OpenStreetMap contributors &copy; CARTO',
        tileSize: 512,
        tilePixelRatio: 2,
        transition: 0,
        wrapX: false
      })
    });

    const view = new ol.View({
      center: ol.proj.fromLonLat([0, 15]),
      zoom: 2,
      constrainResolution: true,
      enableRotation: false
    });

    const map = new ol.Map({
      target: "map",
      layers: [base],
      view,
      controls: ol.control.defaults.defaults({ attribution: true }),
      pixelRatio: 1
    });

    const countriesSource = new ol.source.Vector({ wrapX: false });
    const countriesLayer = new ol.layer.Vector({ source: countriesSource, style: baseStyle });
    map.addLayer(countriesLayer);

    fetch("https://unpkg.com/world-atlas@2/countries-50m.json").then(r=>r.json()).then(topo=>{
      const geo = topojson.feature(topo, topo.objects.countries);
      const fmt = new ol.format.GeoJSON();
      const feats = fmt.readFeatures(geo, { dataProjection: "EPSG:4326", featureProjection: "EPSG:3857" });
      countriesSource.addFeatures(feats);
      buildList(feats);
    });

    function baseStyle(){
      return new ol.style.Style({
        stroke: new ol.style.Stroke({ color: "#2a3545", width: 1.2 }),
        fill: new ol.style.Fill({ color: "rgba(57,66,74,0.85)" })
      });
    }
    function hoverStyle(){
      return new ol.style.Style({
        stroke: new ol.style.Stroke({ color: "#0ea5b7", width: 1.6 }),
        fill: null
      });
    }
    function selectedStyle(){
      return new ol.style.Style({
        stroke: new ol.style.Stroke({ color: "#22d3ee", width: 1.6 }),
        fill: new ol.style.Fill({ color: "rgba(11,58,74,0.6)" })
      });
    }

    let hoveredFeature = null;
    let selectedFeature = null;

    map.on("pointermove", function(evt){
      if (tooltip) { tooltip.style.display = "none"; }
      if (hoveredFeature) { hoveredFeature.setStyle(null); hoveredFeature = null; }
      map.forEachFeatureAtPixel(evt.pixel, function(feat, layer){
        if (layer !== countriesLayer) return;
        hoveredFeature = feat;
        feat.setStyle(hoverStyle());
        const name = feat.get("name") || `N3 ${feat.getId()}`;
        showTip(evt.originalEvent.clientX, evt.originalEvent.clientY, name);
      }, { hitTolerance: 2 });
    });

    map.on("click", function(evt){
      if (selectedFeature) { selectedFeature.setStyle(null); selectedFeature = null; }
      map.forEachFeatureAtPixel(evt.pixel, function(feat, layer){
        if (layer !== countriesLayer) return;
        selectedFeature = feat;
        feat.setStyle(selectedStyle());
        const geom = feat.getGeometry();
        if (geom) { map.getView().fit(geom, { padding: [20,20,20,20], duration: 200 }); }
        const name = feat.get("name") || `N3 ${feat.getId()}`;
        if (nameEl) nameEl.textContent = name;
      }, { hitTolerance: 2 });
    });

    function showTip(x,y,text){
      if (!tooltip) return;
      tooltip.textContent = text;
      tooltip.style.left = x + "px";
      tooltip.style.top = y + "px";
      tooltip.style.display = "block";
    }

    function buildList(features){
      const items = features
        .map(f => ({ name: f.get("name") || `N3 ${f.getId()}`, id: f.getId(), feature: f }))
        .sort((a,b) => a.name.localeCompare(b.name));

      listEl.innerHTML = "";
      for (const it of items){
        const li = document.createElement("li");
        li.textContent = it.name;
        li.dataset.id = it.id;
        li.onclick = () => {
          if (selectedFeature) selectedFeature.setStyle(null);
          selectedFeature = it.feature;
          selectedFeature.setStyle(selectedStyle());
          const g = it.feature.getGeometry();
          if (g) map.getView().fit(g, { padding:[20,20,20,20], duration:200 });
          if (nameEl) nameEl.textContent = it.name;
          highlightList(String(it.id));
        };
        listEl.appendChild(li);
      }

      const search = $("#search");
      if (search){
        search.addEventListener("input", () => {
          const q = search.value.trim().toLowerCase();
          if (!q){
            Array.from(listEl.children).forEach(li => li.style.display = "");
            if (badgeEl) badgeEl.textContent = "—";
            return;
          }
          Array.from(listEl.children).forEach(li => {
            const ok = li.textContent.toLowerCase().includes(q);
            li.style.display = ok ? "" : "none";
          });
          const first = items.find(x => x.name.toLowerCase().includes(q));
          if (badgeEl) badgeEl.textContent = first ? first.name : "—";
        });
        search.addEventListener("keydown",(ev)=>{
          if (ev.key === "Enter"){
            ev.preventDefault();
            const q = search.value.trim().toLowerCase();
            const first = items.find(x => x.name.toLowerCase().includes(q));
            if (first){
              first.feature && map.getView().fit(first.feature.getGeometry(), { padding:[20,20,20,20], duration:200 });
              if (nameEl) nameEl.textContent = first.name;
              highlightList(String(first.id));
            }
          }
        });
      }
    }

    function highlightList(id){
      Array.from(listEl.children).forEach(li => li.classList.remove("is-active"));
      const el = Array.from(listEl.children).find(li => li.dataset.id === id);
      if (el) el.classList.add("is-active");
    }
  })();
  </script>
</body>
</html>
